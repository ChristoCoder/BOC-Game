<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fill-in-the-Blank Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
    }
    input[type="file"], .preloaded-files {
      margin-bottom: 20px;
    }
    .controls {
      margin-bottom: 20px;
    }
    .controls button {
      margin-left: 10px;
    }
    .game-container {
      margin-top: 20px;
    }
    input[type="text"] {
      width: 100px;
      margin: 0 5px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    input.correct {
      background-color: #d4edda;
    }
    input.incorrect {
      background-color: #f8d7da;
    }
  </style>
</head>
<body>
  <h1>Fill-in-the-Blank Game</h1>
  
  <div class="preloaded-files">
    <h3>Preloaded Files:</h3>
    <button data-text="Lesson Eight - The Church - The Two Aspects of the Church <br>
        V. The two aspects of the church: <br>
        A. The universal aspect  <br>
        1. the universal church. <br>
        2. As revealed by the Lord in Matthew 16:18:  <br>
        a. To be built by Christ, the Son of the living God revealed by the Father  <br>
        b. On the rock of the revelation concerning Christ, the Son of the living God <br>
        c. The gates of Hades (Satan's power of darkness) not prevailing against it  <br>
        d. Related to the kingdom of the heavens  <br>
        3. As revealed by the Apostle Paul in the Epistles: <br>
        a. The house of the living God, the pillar and base of the truth, for His manifestation in the flesh  <br>
        b. The Body of Christ, the fullness of the One who fills all in all, for His expression  <br>
        (1) Constituted of all the believers baptized in one Spirit and given to drink one Spirit.  <br>
        (2) Constituted with the unsearchable riches of Christ  <br>
        c. The wife of Christ <br>
        (1) . Coming out of Christ  <br>
        (2) To be one with Christ <br>
        d. The new man <br>
        (1) Not of the natural man.  <br>
        (2) With Christ as all the members and in all the members  <br>
        B. The local aspect: <br>
        1. The local churches  <br>
        2. As revealed by the Lord in Matthew 18:17:  <br>
        a. For the church's administration in its locality. <br>
        b. To bind and to loose with the authority of the heavens  <br>
        3. As revealed by the apostles in Acts and the Epistles: <br>
        a. Established locally in separate cities <br>
        b. Taking a city as the boundary and ground of each local church  <br>
        c. Each being not greater nor smaller than its city. <br>
        d. As lamp stands to bear the testimony of Jesus Christ in separate cities  <br>
        e. All the local churches being the one unique Body of Christ in the universe ">Lesson 8</button>
    <button data-text="Lesson Ten - The Relationship Between the Four Special Gifts and the Church
    VII. The relationship between the four special gifts and the church  <br>
    A. The apostles: <br>
    1. In their ministry to produce the churches, the apostles are a gift to the universal church - all the churches. <br>
    2. In their ministry to appoint the elders, they have an office over all the local churches  <br>
    3. The first gift placed by God in the church  <br>
    B. The prophets: <br>
    1. A gift mainly for the local church  <br>
    2. Also for all the local churches  <br>
    3. Speaking for God and speaking forth God spiritually and predicting for God miraculously  <br>
    4. The second gift placed by God in the church  <br>
    C. The evangelists  <br>
    1. For all the local churches  <br>
    2. Doing the particular work of preaching the gospel  <br>
    D. The shepherd-teachers  <br>
    1. A gift for the local church <br> 
    2. Teaching in the local church meetings. <br>
    3. The third placed by God in the church  <br>
    E. All the four special gifts not building the Body of Christ directly but perfecting the saints that they may build the Body of Christ directly ">Lesson 10</button>
    <button data-text="Lesson Eleven - The Fellowship among the Churches (1-2) 
    VIII. The fellowship among the churches: <br>
    B. All the churches being the one universal Body of Christ  <br>
    1. Among the churches there being no organization but the fellowship of the Body of Christ. <br>
    2. All the churches being on the same level, none being the head church, nor any ruling over another, as indicated by the seven churches in Revelation chapters one through three  <br>
    3. All the churches being the same in:  <br>
    a. Receiving the teachings  <br>
    b. Practicing the church life  <br>
    c. Acting together  <br>
    4. All the churches being identical, like the seven golden lampstands as the symbol of the seven churches   <br>
    5. Only in their degradation the seven churches bearing their different characteristics respectively">Lesson 11</button>
    <button data-text="Lesson Twelve - The Ground of the Church (1) 
    I. The expression of the church: <br>
    D. Two or three meeting together  <br>
    1. The Lord's word is very clear and definite that two or three meeting in His name are one thing and the church is another; the two or three cannot be the church, but only a part of the church, if there is in their locality a church existing of more than two or three. <br>
    2. Therefore, even if we meet in the name of the Lord by two or three, having the Lord in our midst, we still cannot be the church if our number of two or three does not include all the saints in our locality. <br>
    F. The Lord's twofold recovery-the spirit and the local expression of the church; the aspect of the spirit is for life, and the aspect of the local church is for the way. <br>
    II. The practicality of the church: <br>
    A. The practicality of the local church. <br>
    B. A church to which we can go  <br>
    C. Four aspects of the practicality of the church: <br>
    1. The building. <br>
    2. The administration <br> 
    3. The work  <br>
    4. The coordination. <br>
    D. Ye also are builded ">Lesson 12</button>
    <button data-text="Lesson Thirteen - The Ground of the Church (2) 
    I. The oneness of the church: <br>
    A. The unity of the Spirit. <br>
    B. The unity of the faith <br>
    C. Wind of doctrine. <br>
    D. The need of growth in life  <br>
    E. Insisting on nothing but the faith  <br>
    F. Wrecked for the local church. <br>
    G. Arriving at the unity of the faith ">Lesson 13</button>
    <button data-text="Lesson Fifteen - The Ground of the Church (4) 
    I. The unique ground of unity: <br>
    A. Two ways of enjoying Christ: <br>
    1. The enjoyment of the riches of the good land by the people individually; this is the personal and individual way.  <br>
    2. The enjoyment of the riches of the good land as a corporate worship to the Lord. <br>
    B. The unique ground keeps the unity   <br>
    1. There were twelve tribes in the good land, but the Lord only chose Jerusalem. <br>
    2. The ground of unity keeps all the dissenting elements away and closes all the doors to division. <br>
    C. The definiteness of the ground   <br>
    D. Who is narrow? - The church in the locality is not narrow; it includes all the believers in that locality.">Lesson 15</button>
  </div>

  <input type="file" id="fileInput" accept=".txt" />
  
  <div class="controls">
    <label for="difficulty">Select Difficulty: </label>
    <select id="difficulty">
      <option value="10">Easy</option>
      <option value="30">Medium</option>
      <option value="40">Hard</option>
      <option value="">Study</option>
    </select>
    <button id="refreshGame">Refresh Game</button>
  </div>
  
  <div class="game-container" id="gameContainer"></div>
  <button id="hintButton" disabled>Get Hint</button>

  <script>
    const fileInput = document.getElementById('fileInput');
    const difficultySelector = document.getElementById('difficulty');
    const gameContainer = document.getElementById('gameContainer');
    const refreshButton = document.getElementById('refreshGame');
    const hintButton = document.getElementById('hintButton');
    const preloadedButtons = document.querySelectorAll('.preloaded-files button');

    let originalText = ''; // Stores the full text from the uploaded or preloaded file
    let focusedInput = null; // Track the currently focused input field
    const blacklist = ['a', 'an', 'the', 'and', 'or', 'but', 'is', 'are', 'was', 'were', 'in', 'on', 'at', 'of', 'to', 'for', 'by', 'that', 'this', 'with', 'as', 'I', 'we', 'you', 'he', 'she', 'it', 'they', '1.', '2.', '3.', '4.', '5.', '6.', '7.', '8.', '9.', '10.', 'i.', 'ii.', 'iii.', 'iv.', 'v.', 'vi.', 'vii.', 'viii.', 'ix.', 'x.', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z'];

    fileInput.addEventListener('change', handleFile);
    difficultySelector.addEventListener('change', regenerateGame);
    refreshButton.addEventListener('click', regenerateGame);
    hintButton.addEventListener('click', provideHint);

    // Add event listeners for preloaded files
    preloadedButtons.forEach(button => {
      button.addEventListener('click', () => {
        originalText = button.dataset.text;
        generateGame();
      });
    });

    function handleFile(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          originalText = e.target.result.trim();
          generateGame();
        };
        reader.readAsText(file);
      }
    }

    function generateGame() {
        if (!originalText) return; // If no file is loaded, do nothing

        const difficulty = parseInt(difficultySelector.value);
        gameContainer.innerHTML = ''; // Clear previous game content

        const lines = originalText
            .replace(/<br\s*\/?>/g, '\n') // Convert <br> tags to newlines
            .replace(/<[^>]*>/g, '') // Remove any remaining HTML tags
            .split(/\r?\n/) // Split into lines
            .map(line => line.trim());

        const title = lines.shift(); // Remove the first line as the title
        displayTitle(title); // Display the title but don't use it for the game

        lines.forEach(line => {
            const words = line.split(/(\s+|(?=\W)|(?<=\W))/); // Split on spaces, punctuation, or standalone words

            // Filter words eligible for blanks
            const candidates = words
            .map((word, index) => ({ word, index }))
            .filter(({ word }) =>
                word.match(/^\w+$/) && // Exclude non-word patterns (e.g., punctuation or whitespace)
                !blacklist.includes(word.toLowerCase()) && // Exclude blacklist words
                !isBibleReference(word) && // Exclude Bible references
                !isNumber(word) // Exclude numbers
            );

            // Calculate the number of blanks
            const maxRemovable = Math.max(0, candidates.length - 1); // Leave at least one word
            const numToRemove = Math.min(Math.ceil((difficulty / 100) * candidates.length), maxRemovable);

            let indicesToRemove = [];
            while (indicesToRemove.length < numToRemove) {
            const index = Math.floor(Math.random() * candidates.length);
            if (!indicesToRemove.includes(candidates[index].index)) {
                indicesToRemove.push(candidates[index].index);
            }
            }

            // Replace words with blanks
            const lineWithBlanks = words
            .map((word, index) =>
                indicesToRemove.includes(index)
                ? `<input type="text" data-answer="${word}" />`
                : word
            )
            .join('');

            const lineElement = document.createElement('p');
            lineElement.innerHTML = lineWithBlanks;
            gameContainer.appendChild(lineElement);
        });

        hintButton.disabled = false; // Enable the hint button
        addEventListenersToInputs();
}

function displayTitle(title) {
  const titleElement = document.createElement('h2');
  titleElement.textContent = title;
  gameContainer.prepend(titleElement); // Add the title at the top
}

function isBibleReference(word) {
  return /^\w+\s\d+:\d+(-\d+)?$/.test(word); // Matches patterns like "John 3:16" or "John 3:16-17"
}

function isNumber(word) {
  return !isNaN(word) && word.trim() !== ''; // Check if the word is a number
}

    function addEventListenersToInputs() {
      const inputs = gameContainer.querySelectorAll('input[type="text"]');
      inputs.forEach(input => {
        input.addEventListener('keyup', function (e) {
          if (e.key === 'Enter') {
            const correctAnswer = input.dataset.answer;
            if (input.value.trim() === correctAnswer) {
              input.classList.add('correct');
              input.classList.remove('incorrect');
            } else {
              input.classList.add('incorrect');
              input.classList.remove('correct');
            }
          }
        });

        // Track the focused input field
        input.addEventListener('focus', function () {
          focusedInput = input; // Store the currently focused input
        });
      });
    }

    function regenerateGame() {
      if (!originalText) {
        alert('Please load a text file first!');
        return;
      }
      generateGame(); // Regenerate game with current difficulty
    }

    function provideHint() {
      if (focusedInput && focusedInput.dataset.answer) {
        const correctAnswer = focusedInput.dataset.answer;
        focusedInput.value = correctAnswer.charAt(0); // Show the first letter as a hint
        focusedInput.focus(); // Keep focus on the input
      }
    }
  </script>
</body>
</html>
